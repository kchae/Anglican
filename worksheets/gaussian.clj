;; gorilla-repl.fileformat = 1

;; **
;;; Boiler-plate code --- importing necessary things.
;; **

;; @@
(use 'nstools.ns)
(ns+ gaussian
  (:like anglican-user.worksheet))
;; @@
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[nil,nil]"}
;; <=

;; **
;;; Let us define a simple query.
;; **

;; @@
;Problem: try to estimate the mean of a Gaussian distribution.

;Data
(def y1 9)
(def y2 8)
(def dataset [y1 y2])

;Model
(defquery gaussian-model [y1 y2]
  (let [sigma2 2
        mu (sample (normal 1 (sqrt 5)))
        outcome-dist (normal mu (sqrt sigma2))]
    (observe outcome-dist y1)
    (observe outcome-dist y2)
  mu))

;Prior
(def prior-samples 
  (repeatedly 10000 #(sample* (normal 1 (sqrt 5)))))
;Posteror
(def posterior-samples  
  (take 10000
        (drop 10000
              (map :result
                   (doquery :rmh gaussian-model [y1 y2] 
                            :number-of-particles 1000)))))
;Visualization
(println "Prior on mu (blue) and posterior (green)")
(plot/compose
 (plot/histogram prior-samples
                 :normalize :probability-density :bins 40
                 :plot-range [[-10 10] [0 0.8]])
 (plot/histogram posterior-samples
                 :normalize :probability-density :bins 40
                 :color :green))
;; @@
;; ->
;;; Prior on mu (blue) and posterior (green)
;;; 
;; <-
;; =>
;;; {"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"list-like","open":"","close":"","separator":"</pre><pre>","items":[{"type":"html","content":"<span class='clj-var'>#&#x27;gaussian/y1</span>","value":"#'gaussian/y1"},{"type":"html","content":"<span class='clj-var'>#&#x27;gaussian/y2</span>","value":"#'gaussian/y2"}],"value":"[#'gaussian/y1,#'gaussian/y2]"},{"type":"html","content":"<span class='clj-var'>#&#x27;gaussian/dataset</span>","value":"#'gaussian/dataset"}],"value":"[[#'gaussian/y1,#'gaussian/y2],#'gaussian/dataset]"},{"type":"html","content":"<span class='clj-var'>#&#x27;gaussian/gaussian-model</span>","value":"#'gaussian/gaussian-model"}],"value":"[[[#'gaussian/y1,#'gaussian/y2],#'gaussian/dataset],#'gaussian/gaussian-model]"},{"type":"html","content":"<span class='clj-var'>#&#x27;gaussian/prior-samples</span>","value":"#'gaussian/prior-samples"}],"value":"[[[[#'gaussian/y1,#'gaussian/y2],#'gaussian/dataset],#'gaussian/gaussian-model],#'gaussian/prior-samples]"},{"type":"html","content":"<span class='clj-var'>#&#x27;gaussian/posterior-samples</span>","value":"#'gaussian/posterior-samples"}],"value":"[[[[[#'gaussian/y1,#'gaussian/y2],#'gaussian/dataset],#'gaussian/gaussian-model],#'gaussian/prior-samples],#'gaussian/posterior-samples]"},{"type":"html","content":"<span class='clj-nil'>nil</span>","value":"nil"}],"value":"[[[[[[#'gaussian/y1,#'gaussian/y2],#'gaussian/dataset],#'gaussian/gaussian-model],#'gaussian/prior-samples],#'gaussian/posterior-samples],nil]"},{"type":"vega","content":{"width":400,"height":247.2187957763672,"padding":{"top":10,"left":55,"bottom":40,"right":10},"scales":[{"name":"x","type":"linear","range":"width","zero":false,"domain":[-10,10]},{"name":"y","type":"linear","range":"height","nice":true,"zero":false,"domain":[0,0.8]}],"axes":[{"type":"x","scale":"x"},{"type":"y","scale":"y"}],"data":[{"name":"d6911803-3f9d-4a1a-b4d4-9f32fd41d5ad","values":[{"x":-10,"y":0},{"x":-9.5,"y":0},{"x":-9,"y":0},{"x":-8.5,"y":0},{"x":-8,"y":0},{"x":-7.5,"y":0.0002},{"x":-7,"y":0.0002},{"x":-6.5,"y":0.0002},{"x":-6,"y":0.001},{"x":-5.5,"y":0.0016},{"x":-5,"y":0.004},{"x":-4.5,"y":0.0052},{"x":-4,"y":0.0114},{"x":-3.5,"y":0.0174},{"x":-3,"y":0.0282},{"x":-2.5,"y":0.0438},{"x":-2,"y":0.061},{"x":-1.5,"y":0.0778},{"x":-1,"y":0.1098},{"x":-0.5,"y":0.1328},{"x":0,"y":0.1574},{"x":0.5,"y":0.1754},{"x":1,"y":0.1806},{"x":1.5,"y":0.1754},{"x":2,"y":0.1676},{"x":2.5,"y":0.152},{"x":3,"y":0.1262},{"x":3.5,"y":0.1086},{"x":4,"y":0.0824},{"x":4.5,"y":0.0632},{"x":5,"y":0.045},{"x":5.5,"y":0.0294},{"x":6,"y":0.0168},{"x":6.5,"y":0.012},{"x":7,"y":0.0064},{"x":7.5,"y":0.0044},{"x":8,"y":0.0012},{"x":8.5,"y":0.0004},{"x":9,"y":0.0006},{"x":9.5,"y":0.0002},{"x":10,"y":0.0002},{"x":10.5,"y":0},{"x":11,"y":0}]},{"name":"05389a90-89b4-4609-a2b6-b24a93ca7e99","values":[{"x":3.7748909769401813,"y":0},{"x":3.9406351624245595,"y":0.0012066788310884711},{"x":4.106379347908938,"y":0.0024133576621769423},{"x":4.272123533393316,"y":0.009050091233163533},{"x":4.437867718877694,"y":0.0012066788310884711},{"x":4.603611904362072,"y":0.003620036493265413},{"x":4.76935608984645,"y":0.013273467141973182},{"x":4.935100275330829,"y":0.009653430648707769},{"x":5.100844460815207,"y":0.026546934283946364},{"x":5.266588646299585,"y":0.03258032843938872},{"x":5.432332831783963,"y":0.05249052915234849},{"x":5.598077017268341,"y":0.07602076635857367},{"x":5.76382120275272,"y":0.0730040692808525},{"x":5.929565388237098,"y":0.13575136849745298},{"x":6.095309573721476,"y":0.1779851275855495},{"x":6.261053759205854,"y":0.1906552553119784},{"x":6.426797944690232,"y":0.25038585745085773},{"x":6.5925421301746105,"y":0.3294233208871526},{"x":6.758286315658989,"y":0.32037322965398907},{"x":6.924030501143367,"y":0.3668303646508952},{"x":7.089774686627745,"y":0.43681773685402653},{"x":7.255518872112123,"y":0.4760347988644018},{"x":7.4212630575965015,"y":0.40484074783018204},{"x":7.58700724308088,"y":0.42173425146542065},{"x":7.752751428565258,"y":0.40182405075246086},{"x":7.918495614049636,"y":0.3264066238094314},{"x":8.084239799534014,"y":0.3758804558840587},{"x":8.249983985018392,"y":0.3089097807586486},{"x":8.41572817050277,"y":0.22383892316691137},{"x":8.581472355987149,"y":0.18462186115653606},{"x":8.747216541471527,"y":0.14299144148398382},{"x":8.912960726955905,"y":0.09894766414925463},{"x":9.078704912440283,"y":0.04102708025700801},{"x":9.244449097924662,"y":0.035597025517109894},{"x":9.41019328340904,"y":0.02956363136166754},{"x":9.575937468893418,"y":0.03318366785493295},{"x":9.741681654377796,"y":0.009653430648707769},{"x":9.907425839862174,"y":0.007240072986530826},{"x":10.073170025346553,"y":0},{"x":10.23891421083093,"y":0},{"x":10.404658396315309,"y":0.0018100182466327065},{"x":10.570402581799687,"y":0}]}],"marks":[{"type":"line","from":{"data":"d6911803-3f9d-4a1a-b4d4-9f32fd41d5ad"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"steelblue"},"fillOpacity":{"value":0.4},"stroke":{"value":"steelblue"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}},{"type":"line","from":{"data":"05389a90-89b4-4609-a2b6-b24a93ca7e99"},"properties":{"enter":{"x":{"scale":"x","field":"data.x"},"y":{"scale":"y","field":"data.y"},"interpolate":{"value":"step-before"},"fill":{"value":"green"},"fillOpacity":{"value":0.4},"stroke":{"value":"green"},"strokeWidth":{"value":2},"strokeOpacity":{"value":1}}}}]},"value":"#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain [-10 10]} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain [0 0.8]}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"d6911803-3f9d-4a1a-b4d4-9f32fd41d5ad\", :values ({:x -10.0, :y 0} {:x -9.5, :y 0.0} {:x -9.0, :y 0.0} {:x -8.5, :y 0.0} {:x -8.0, :y 0.0} {:x -7.5, :y 2.0E-4} {:x -7.0, :y 2.0E-4} {:x -6.5, :y 2.0E-4} {:x -6.0, :y 0.001} {:x -5.5, :y 0.0016} {:x -5.0, :y 0.004} {:x -4.5, :y 0.0052} {:x -4.0, :y 0.0114} {:x -3.5, :y 0.0174} {:x -3.0, :y 0.0282} {:x -2.5, :y 0.0438} {:x -2.0, :y 0.061} {:x -1.5, :y 0.0778} {:x -1.0, :y 0.1098} {:x -0.5, :y 0.1328} {:x 0.0, :y 0.1574} {:x 0.5, :y 0.1754} {:x 1.0, :y 0.1806} {:x 1.5, :y 0.1754} {:x 2.0, :y 0.1676} {:x 2.5, :y 0.152} {:x 3.0, :y 0.1262} {:x 3.5, :y 0.1086} {:x 4.0, :y 0.0824} {:x 4.5, :y 0.0632} {:x 5.0, :y 0.045} {:x 5.5, :y 0.0294} {:x 6.0, :y 0.0168} {:x 6.5, :y 0.012} {:x 7.0, :y 0.0064} {:x 7.5, :y 0.0044} {:x 8.0, :y 0.0012} {:x 8.5, :y 4.0E-4} {:x 9.0, :y 6.0E-4} {:x 9.5, :y 2.0E-4} {:x 10.0, :y 2.0E-4} {:x 10.5, :y 0.0} {:x 11.0, :y 0})} {:name \"05389a90-89b4-4609-a2b6-b24a93ca7e99\", :values ({:x 3.7748909769401813, :y 0} {:x 3.9406351624245595, :y 0.0012066788310884711} {:x 4.106379347908938, :y 0.0024133576621769423} {:x 4.272123533393316, :y 0.009050091233163533} {:x 4.437867718877694, :y 0.0012066788310884711} {:x 4.603611904362072, :y 0.003620036493265413} {:x 4.76935608984645, :y 0.013273467141973182} {:x 4.935100275330829, :y 0.009653430648707769} {:x 5.100844460815207, :y 0.026546934283946364} {:x 5.266588646299585, :y 0.03258032843938872} {:x 5.432332831783963, :y 0.05249052915234849} {:x 5.598077017268341, :y 0.07602076635857367} {:x 5.76382120275272, :y 0.0730040692808525} {:x 5.929565388237098, :y 0.13575136849745298} {:x 6.095309573721476, :y 0.1779851275855495} {:x 6.261053759205854, :y 0.1906552553119784} {:x 6.426797944690232, :y 0.25038585745085773} {:x 6.5925421301746105, :y 0.3294233208871526} {:x 6.758286315658989, :y 0.32037322965398907} {:x 6.924030501143367, :y 0.3668303646508952} {:x 7.089774686627745, :y 0.43681773685402653} {:x 7.255518872112123, :y 0.4760347988644018} {:x 7.4212630575965015, :y 0.40484074783018204} {:x 7.58700724308088, :y 0.42173425146542065} {:x 7.752751428565258, :y 0.40182405075246086} {:x 7.918495614049636, :y 0.3264066238094314} {:x 8.084239799534014, :y 0.3758804558840587} {:x 8.249983985018392, :y 0.3089097807586486} {:x 8.41572817050277, :y 0.22383892316691137} {:x 8.581472355987149, :y 0.18462186115653606} {:x 8.747216541471527, :y 0.14299144148398382} {:x 8.912960726955905, :y 0.09894766414925463} {:x 9.078704912440283, :y 0.04102708025700801} {:x 9.244449097924662, :y 0.035597025517109894} {:x 9.41019328340904, :y 0.02956363136166754} {:x 9.575937468893418, :y 0.03318366785493295} {:x 9.741681654377796, :y 0.009653430648707769} {:x 9.907425839862174, :y 0.007240072986530826} {:x 10.073170025346553, :y 0.0} {:x 10.23891421083093, :y 0.0} {:x 10.404658396315309, :y 0.0018100182466327065} {:x 10.570402581799687, :y 0})}), :marks ({:type \"line\", :from {:data \"d6911803-3f9d-4a1a-b4d4-9f32fd41d5ad\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"05389a90-89b4-4609-a2b6-b24a93ca7e99\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value :green}, :fillOpacity {:value 0.4}, :stroke {:value :green}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}"}],"value":"[[[[[[[#'gaussian/y1,#'gaussian/y2],#'gaussian/dataset],#'gaussian/gaussian-model],#'gaussian/prior-samples],#'gaussian/posterior-samples],nil],#gorilla_repl.vega.VegaView{:content {:width 400, :height 247.2188, :padding {:top 10, :left 55, :bottom 40, :right 10}, :scales [{:name \"x\", :type \"linear\", :range \"width\", :zero false, :domain [-10 10]} {:name \"y\", :type \"linear\", :range \"height\", :nice true, :zero false, :domain [0 0.8]}], :axes [{:type \"x\", :scale \"x\"} {:type \"y\", :scale \"y\"}], :data ({:name \"d6911803-3f9d-4a1a-b4d4-9f32fd41d5ad\", :values ({:x -10.0, :y 0} {:x -9.5, :y 0.0} {:x -9.0, :y 0.0} {:x -8.5, :y 0.0} {:x -8.0, :y 0.0} {:x -7.5, :y 2.0E-4} {:x -7.0, :y 2.0E-4} {:x -6.5, :y 2.0E-4} {:x -6.0, :y 0.001} {:x -5.5, :y 0.0016} {:x -5.0, :y 0.004} {:x -4.5, :y 0.0052} {:x -4.0, :y 0.0114} {:x -3.5, :y 0.0174} {:x -3.0, :y 0.0282} {:x -2.5, :y 0.0438} {:x -2.0, :y 0.061} {:x -1.5, :y 0.0778} {:x -1.0, :y 0.1098} {:x -0.5, :y 0.1328} {:x 0.0, :y 0.1574} {:x 0.5, :y 0.1754} {:x 1.0, :y 0.1806} {:x 1.5, :y 0.1754} {:x 2.0, :y 0.1676} {:x 2.5, :y 0.152} {:x 3.0, :y 0.1262} {:x 3.5, :y 0.1086} {:x 4.0, :y 0.0824} {:x 4.5, :y 0.0632} {:x 5.0, :y 0.045} {:x 5.5, :y 0.0294} {:x 6.0, :y 0.0168} {:x 6.5, :y 0.012} {:x 7.0, :y 0.0064} {:x 7.5, :y 0.0044} {:x 8.0, :y 0.0012} {:x 8.5, :y 4.0E-4} {:x 9.0, :y 6.0E-4} {:x 9.5, :y 2.0E-4} {:x 10.0, :y 2.0E-4} {:x 10.5, :y 0.0} {:x 11.0, :y 0})} {:name \"05389a90-89b4-4609-a2b6-b24a93ca7e99\", :values ({:x 3.7748909769401813, :y 0} {:x 3.9406351624245595, :y 0.0012066788310884711} {:x 4.106379347908938, :y 0.0024133576621769423} {:x 4.272123533393316, :y 0.009050091233163533} {:x 4.437867718877694, :y 0.0012066788310884711} {:x 4.603611904362072, :y 0.003620036493265413} {:x 4.76935608984645, :y 0.013273467141973182} {:x 4.935100275330829, :y 0.009653430648707769} {:x 5.100844460815207, :y 0.026546934283946364} {:x 5.266588646299585, :y 0.03258032843938872} {:x 5.432332831783963, :y 0.05249052915234849} {:x 5.598077017268341, :y 0.07602076635857367} {:x 5.76382120275272, :y 0.0730040692808525} {:x 5.929565388237098, :y 0.13575136849745298} {:x 6.095309573721476, :y 0.1779851275855495} {:x 6.261053759205854, :y 0.1906552553119784} {:x 6.426797944690232, :y 0.25038585745085773} {:x 6.5925421301746105, :y 0.3294233208871526} {:x 6.758286315658989, :y 0.32037322965398907} {:x 6.924030501143367, :y 0.3668303646508952} {:x 7.089774686627745, :y 0.43681773685402653} {:x 7.255518872112123, :y 0.4760347988644018} {:x 7.4212630575965015, :y 0.40484074783018204} {:x 7.58700724308088, :y 0.42173425146542065} {:x 7.752751428565258, :y 0.40182405075246086} {:x 7.918495614049636, :y 0.3264066238094314} {:x 8.084239799534014, :y 0.3758804558840587} {:x 8.249983985018392, :y 0.3089097807586486} {:x 8.41572817050277, :y 0.22383892316691137} {:x 8.581472355987149, :y 0.18462186115653606} {:x 8.747216541471527, :y 0.14299144148398382} {:x 8.912960726955905, :y 0.09894766414925463} {:x 9.078704912440283, :y 0.04102708025700801} {:x 9.244449097924662, :y 0.035597025517109894} {:x 9.41019328340904, :y 0.02956363136166754} {:x 9.575937468893418, :y 0.03318366785493295} {:x 9.741681654377796, :y 0.009653430648707769} {:x 9.907425839862174, :y 0.007240072986530826} {:x 10.073170025346553, :y 0.0} {:x 10.23891421083093, :y 0.0} {:x 10.404658396315309, :y 0.0018100182466327065} {:x 10.570402581799687, :y 0})}), :marks ({:type \"line\", :from {:data \"d6911803-3f9d-4a1a-b4d4-9f32fd41d5ad\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value \"steelblue\"}, :fillOpacity {:value 0.4}, :stroke {:value \"steelblue\"}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}} {:type \"line\", :from {:data \"05389a90-89b4-4609-a2b6-b24a93ca7e99\"}, :properties {:enter {:x {:scale \"x\", :field \"data.x\"}, :y {:scale \"y\", :field \"data.y\"}, :interpolate {:value \"step-before\"}, :fill {:value :green}, :fillOpacity {:value 0.4}, :stroke {:value :green}, :strokeWidth {:value 2}, :strokeOpacity {:value 1}}}})}}]"}
;; <=

;; @@

;; @@
